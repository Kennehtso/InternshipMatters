{% extends 'general/main.html'%}

{% block otherCSS %}
{% endblock otherCSS %}

{% block content %}
{% include './component/orgSupplyModal.html'%}

<!--Success / Error Messages -->
{% for msg in messages %}
    {% if msg.level == DEFAULT_MESSAGE_LEVELS.SUCCESS %}
        <div id='{{msg}}' class="text-center alert alert-success alert-dismissible fade show">
    {% elif msg.level == DEFAULT_MESSAGE_LEVELS.ERROR %}
        <div id='{{msg}}' class="text-center alert alert-danger alert-dismissible fade show">
    {% elif msg.level == DEFAULT_MESSAGE_LEVELS.WARNING %}
        <div id='{{msg}}' class="text-center alert alert-warning alert-dismissible fade show">
    {% endif %}
        <strong>{{msg}}</strong>
        <button type="button" class="close" data-dismiss="alert">&times;</button>
    </div>
{% endfor %}
<a id="pagerDisplay">
  第 <span id="currentPage">1</span> / {{ page_obj.paginator.num_pages }} 頁
</a>
<div class="row" style="padding-top: 10px; padding-bottom: 20px;">
  <div class="col-md-10 col-lg-8 col-xl-6 mx-auto" style="box-shadow: 3px 3px 5px gray;">
    <form id="searchForm" method="post" action="/result/">{% csrf_token %}
      <div class="form-row">
        <div class="btn-group col-md-8 col-lg-8 col-xl-8 mb-3 mb-md-0">
          <input name="bannerSearch" id="bannerSearch" type="search" class="form-control form-control-lg"
            placeholder="機構名稱 / 類型">
        </div>
        <!--Search Button -->
        <div class="btn-group col-md-2 col-lg-2 col-xl-2 mb-2 mb-md-0">
          <button type="submit" class="btn btn-lg btn-info">搜尋</button>
        </div>
        <div class="btn-group col-md-2 col-lg-2 col-xl-2 mb-2 mb-md-0">
          <button type="button" onclick="resetCondition()" class="btn btn-lg btn-danger">重設</button>
        </div>
      </div>

      <div class="form-row" style="padding-top: 10px;">
        <!--地區-->
        <select id="location_list" name="location_list" data-style="btn-outline-info"
          class="selectpicker col-md-5 col-lg-5 col-xl-6 mb-2 mb-md-0" aria-label="全部地區" data-live-search="true">
          <option value='' selected>全部地區</option>
          <option data-divider="true"></option>
          <option value='臺北市'>臺北市</option>
          <option value='基隆市'>基隆市</option>
          <option value='新北市'>新北市</option>
          <option value='宜蘭縣'>宜蘭縣</option>
          <option value='新竹市'>新竹市</option>
          <option value='新竹縣'>新竹縣</option>
          <option value='桃園市'>桃園市</option>
          <option value='苗栗縣'>苗栗縣</option>
          <option value='臺中市'>臺中市</option>
          <option value='雲林縣'>雲林縣</option>
          <option value='臺南市'>臺南市</option>
          <option value='高雄市'>高雄市</option>
          <option value='屏東縣'>屏東縣</option>
          <option value='臺東縣'>臺東縣</option>
          <option value='花蓮縣'>花蓮縣</option>
        </select>
        <!--機構類型-->
        <select id="organizationType_list" name="organizationType_list" data-style="btn-outline-info"
          class="selectpicker col-md-5 col-lg-5 col-xl-6 mb-2 mb-md-0" aria-label="全部機構類型" data-live-search="true">
          <option value='' selected>全部機構類型</option>
          <option data-divider="true"></option>
          <option value="大專校院諮商(輔導)中心(處、室、組)">大專校院諮商(輔導)中心(處、室、組)</option>
          <option value="心理諮商所">心理諮商所</option>
          <option value="公、私立高中、職、中小學輔導室（處）、教育局處學生諮商中心">公、私立高中、職、中小學輔導室（處）、教育局處學生諮商中心</option>
          <option value="醫療機構">醫療機構</option>
          <option value="社區性心理衛生中心">社區性心理衛生中心</option>
          <option value="政府及事業單位設有心理治療或諮商業務之單位">政府及事業單位設有心理治療或諮商業務之單位</option>
          <option value="財團法人基金會">財團法人基金會</option>
        </select>
      </div>


      <div class="form-row" style="padding-top: 10px; padding-bottom: 50px;">
        <div class="form-group searchCustomBorder col-md-5 col-lg-5 col-xl-6 mb-2 mb-md-0">
          <div class="row">
            <label for="score_input" class="col-form-label" style="margin-left: 1.5em;">喜愛度
              <i class="fas fa-heart" style='color: #d6688d;'></i> X <span id="scoreValue"></span> 或以上
              
              <a id="clearRate" class="btn btn-md btn-outline-danger" style="margin-left:10px;margin-top: 10px;"><i class="fa fa-refresh" aria-hidden="true"></i>
              </a>
            </label>
            <div class="rating">
              <input type="radio" name="rating" id="r1">
              <label for="r1"></label>

              <input type="radio" name="rating" id="r2">
              <label for="r2"></label>

              <input type="radio" name="rating" id="r3">
              <label for="r3"></label>

              <input type="radio" name="rating" id="r4">
              <label for="r4"></label>

              <input type="radio" name="rating" id="r5">
              <label for="r5"></label>

              <input type="radio" name="rating" id="r6">
              <label for="r6"></label>
            </div>
            <input style="display: none;" id="score_input" name="score_input" type="range" class="form-range" value="0"
              min="0" max="5" step="1">
          </div>
        </div>
        <!--Search Button -->
        <div class="form-group searchCustomBorder col-md-5 col-lg-5 col-xl-6 mb-2 mb-md-0">
          <div class="row">
            
            <label for="commentsCount_input" class="col-form-label" style="margin-left: 1.5em; display: flex;">討論
              &nbsp;<i class="fas fa-comments" style='color: #17a2b8;'></i>&nbsp;X <span id="commentsCountValue"></span> 或以上
            </label>
            <input id="commentsCount_input" name="commentsCount_input" type="range" value="0" class="form-range" style="margin-left: 3em; "
              min="0" max="99">
          </div>
          <div class="row">
            <label for="isApprove_label" class="col-form-label" style="margin-left: 1.5em; display: flex;">審核類型：
            </label>
            <div id="isApprove_radio" class="btn-group col-sm-9" data-toggle="buttons">
              <label style="width: 5em;border-radius: 0.75em 0em 0em 0.75em;" class="btn btn-outline-info" for="info-outlined"> <input style="display: none;" type="radio"
                  class="btn-check isApprove_all" name="options-outlined" id="info-outlined" autocomplete="off">
                全部 </label>
              <label style="width: 5em;" class="btn btn-outline-success" for="success-outlined"> <input style="display: none;" type="radio"
                  class="btn-check isApprove_true" name="options-outlined" id="success-outlined" autocomplete="off"> 已審核
              </label>
              <label style="width: 5em;border-radius: 0em 0.75em 0.75em 0em;" class="btn btn-outline-danger" for="danger-outlined"><input style="display: none;" type="radio"
                  class="btn-check isApprove_false" name="options-outlined" id="danger-outlined" autocomplete="off"> 非審核
              </label>
              <input style="display: none;" id="isApprove_input" name="isApprove_input" type="text">
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="container">
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark" style="border-radius: 0.75em; box-shadow: 3px 3px 5px gray;">
    <a class="navbar-brand" style="margin: auto; padding-top: 0px; padding-bottom: 0px;">
      心理實習機構 - 符合條件為：<span style="color:teal">{{organizations_count}}</span> 筆</a>
  </nav>
</div>


<!--  RESULT LIST-->
<div id="columns" class="infinite-container">
  {% for item in page_obj %}
  <figure class="resultFigures infinite-item" id="{{item.id}}">
    <h3>{{ item.name }}</h3>
    <p>{{ item.unitName }}</p>
    <p>{{ item.unitType }}</p>
    <p>津貼：{{ item.subsidy }}</p>
    <p>審核類型：

      {% if item.isApprove %}
      <label class="btn btn-outline-success"> 已審核 </label>
      {% else %}
      <label class="btn btn-outline-danger"> 未審核 </label>
      {% endif %}
    </p>
    <input style="display: none;" id="score_{{item.id}}" value="{{item.score}}">
    <figcaption>評論人數：{{ item.commentsCount }}
    <div class="ratingResult" title="{{item.score}}">
      {% for i in '12345'|make_list %}
      {% if item.score >= forloop.counter %}
      <label class='heartColorLevel_{{i}}'>♥</label>
      {% else %}
      <label style='color: #444;text-shadow: 0 0 20px #444;'>♡</label>
      {% endif %}
      {% endfor %}
    </div>
    </figcaption>
    <div>
      {% for hashTag in item.hashTags.all %}
      <button class="btn btn-xs btn-info">{{hashTag.name}}</button>
      {% endfor%}
    </div>
  </figure>
  {% endfor%}
</div>

<!-- Send Org apply -->
<div class="container" style="padding-bottom: 2em;">
  <nav style="border-radius: 0.75em; box-shadow: 3px 3px 5px gray;" class="navbar navbar-expand-lg navbar-dark bg-dark col-xl-12">
      <a style="margin: auto; padding-top: 0px; padding-bottom: 0px;word-break: break-word;white-space: break-spaces;" class="navbar-brand col-xl-2 mb-2">找不到機構嗎？提議一個吧。</a>
      <div class="col-xl-10 mx-auto">
              <div class="form-row">
                <div class="btn-group col-xl-5 mb-2 mx-auto">
                  <input name="organization_new" id="organization_new" type="input" class="form-control form-control-lg" placeholder="機構名稱">
                </div>
                <div class="btn-group col-xl-5 mb-2">
                  <input name="address_new" id="address_new" type="input" class="form-control form-control-lg" placeholder="機構地址">
                </div>
                <!--Send mail Button -->
                <div class="btn-group col-xl-2 mb-2 mx-auto">
                  <a class="organization-apply btn btn-lg btn-info" title="發送提議" data-toggle="modal" data-target="#orgSupplyModal" id="{{item.id}}">
                    發送提議
                  </a>
                  <!--button type="input" class="btn btn-lg btn-info" data-toggle="modal" data-target="#orgSupplyModal">發送提議</button-->
                </div>
              </div>
      </div>
  </nav>
</div>

<!-- infinite  paging -->
{% if page_obj.has_next %}
<a class="infinite-more-link" href="?page={{ page_obj.next_page_number }}">更多</a>
{% endif %}


{% endblock %}

{% block contentJs%}
<script src="https://cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js"
  integrity="sha512-CEiA+78TpP9KAIPzqBvxUv8hy41jyI3f2uHi7DGp/Y/Ka973qgSdybNegWFciqh6GrN2UePx2KkflnQUbUhNIA=="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/shortcuts/infinite.min.js"
  integrity="sha512-m3kH21aSkKrGeoqdb7IP7rlu1VcQee5VrjLQepeSOp5M05Wl6HwqJ1Jwo14EHOuBg77pkAlBtQuVMPVeXzfueg=="
  crossorigin="anonymous"></script>

<script>
  
  $(document).on('click', '.organization-apply', function () {
        var organization_new = $("#organization_new").val();
        var address_new = $("#address_new").val();
        $(".modal-organization_new").text(organization_new);
        $(".modal-address_new").text(address_new);
    });

    $(document).on('click', '#confirmOrgSupply', function () {
      $('#columns').parent().append('<div class="loader text-center"></div>').append('<div class="loader-text text-center">提議發送中</div>');
        var organization_new = $("#organization_new").val().replace(/^\s+|\s+$/g, '');
        var address_new = $("#address_new").val().replace(/^\s+|\s+$/g, '');
        $(".alert-dismissible").remove();
        //alert(cmtId);
        $.ajax({
            type: "POST",
            url: "{% url 'sendmailApply' %}",
            data: { 'organization_new': organization_new, 'address_new':address_new},
            beforeSend: function(xhr) {
                xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            },
        success: function(response){
            //alert(response.success);
            var alertType = "";
            var message = "";
            if (response.success != undefined){
              alertType = "success";
              message = response.success;
            }
            else if (response.fail != undefined){
              alertType = "danger";
              message = response.fail;
            }
            else if (response.warning != undefined){
              alertType = "warning";
              message = response.warning;
            }
            var msgHtml = "<div id="+message+" class='text-center alert alert-"+alertType+" alert-dismissible fade show'><strong>"+message+"</strong>";
            msgHtml += "<button type='button' class='close' data-dismiss='alert'>&times;</button></div>";
            $(".wrapper").prepend(msgHtml);
            $("#organization_new").val("");
            $("#address_new").val("");
            },
        complete : function(response){
            //alert(response.success);
            $('.loader, .loader-text').remove();
            }
        });
    });

  $('#r6').hide();
  $('#r6').next().hide();
  bannerSearch='{{bannerSearch}}';
  location_list='{{location_list}}';
  organizationType_list='{{organizationType_list}}';
  score_input={{score_input}};
  commentsCount_input={{commentsCount_input}};
  isApprove_input='{{isApprove_input}}';

  $('#bannerSearch').val(bannerSearch)
  $('#location_list').val(location_list)
  $('#organizationType_list').val(organizationType_list)
  $('#score_input').val(score_input)
  $('#commentsCount_input').val(commentsCount_input)
  $('#isApprove_input').val(isApprove_input)
  switch (isApprove_input) {
    case "true": $('#success-outlined').trigger('click'); break;
    case "false": $('#danger-outlined').trigger('click'); break;
    default: $('#info-outlined').trigger('click'); $('#info-outlined').attr("checked"); break;
  }
  function resetCondition(){
    //$('#searchForm')[0].reset();
    $("#bannerSearch").val('');
    $("#location_list").val('');
    $("#location_list").selectpicker("refresh");
    $('#organizationType_list').val('');
    $("#organizationType_list").selectpicker("refresh");
    $('#clearRate').trigger('click');
    $('#commentsCountValue').val(0);
    document.getElementById("commentsCountValue").innerHTML = 0;
    $('#commentsCount_input').val(0);
    $('#info-outlined').trigger('click');
  }
  
  var loader = $('.lodaer');
  var infinite = new Waypoint.Infinite({
    element: $('.infinite-container')[0],
    onBeforePageLoad: function () {
      $('#columns').parent().append('<div class="loader text-center"></div>').append('<div class="loader-text text-center">稍等片刻</div>');
    },
    onAfterPageLoad: function ($items) {
      $('.loader, .loader-text').remove();
      $('#currentPage').html(parseInt($('#currentPage').html(),10) + 1);
    }
  });
  let resultsRow = document.getElementsByClassName('resultFigures');

  for (let i = 0; i < resultsRow.length; i++) {
    resultsRow[i].addEventListener("click", () => {
      window.location.href = '/detail/' + resultsRow[i].id;
    });
  }
  var score_input = document.getElementById("score_input");
  var scoreValue = document.getElementById("scoreValue");
  switch (score_input.value) {
    case "1": $('#r5').trigger('click'); break;
    case "2": $('#r4').trigger('click'); break;
    case "3": $('#r3').trigger('click'); break;
    case "4": $('#r2').trigger('click'); break;
    case "5": $('#r1').trigger('click'); break;
  }
  var commentsCount_input = document.getElementById("commentsCount_input");
  var commentsCountValue = document.getElementById("commentsCountValue");
  scoreValue.innerHTML = score_input.value;
  commentsCountValue.innerHTML = commentsCount_input.value;
  score_input.oninput = function () {
    scoreValue.innerHTML = this.value;
  }
  commentsCount_input.oninput = function () {
    commentsCountValue.innerHTML = this.value;
  }

  $('#r1').click(function (e) { $('#score_input').val(5); scoreValue.innerHTML = 5; });
  $('#r2').click(function (e) { $('#score_input').val(4); scoreValue.innerHTML = 4; });
  $('#r3').click(function (e) { $('#score_input').val(3); scoreValue.innerHTML = 3; });
  $('#r4').click(function (e) { $('#score_input').val(2); scoreValue.innerHTML = 2; });
  $('#r5').click(function (e) { $('#score_input').val(1); scoreValue.innerHTML = 1; });
  $('#r6').click(function (e) { $('#score_input').val(0); scoreValue.innerHTML = 0; });
  $('#clearRate').click(function (e) {
    $('#r6').trigger('click');
    $('#r6').next().addClass('added-class');
    $('#score_input').val(0);
    scoreValue.innerHTML = 0;
  });

  $("#isApprove_radio input:radio").change(function () {
    var optionValue = $(this).attr('class').split(" ")[1].split('_')[1];
    $('#isApprove_input').val(optionValue);
  });

</script>
{% endblock contentJs%}